import{isNullOrEmpty as r,trim as u}from"/functions/string/";function c(i){return{all:i=i||new Map,on:function(e,s){var t=i.get(e);t?t.push(s):i.set(e,[s])},off:function(e,s){var t=i.get(e);t&&(s?t.splice(t.indexOf(s)>>>0,1):i.set(e,[]))},emit:function(e,s){var t=i.get(e);t&&t.slice().map(function(a){a(s)}),(t=i.get("*"))&&t.slice().map(function(a){a(e,s)})}}}var h=class{constructor(e){this.registerdApps=[];this.appRouteMap=new Map;this.loadedApps=[];this.onRouteCallbacks=[];this.onBeforeRouteCallbacks=[];this.onAfterRouteCallbacks=[];this.eventBus=c();this.on=(e,s)=>{this.eventBus.on(e,s)};this.off=e=>{this.eventBus.off(e)};this.emit=(e,s)=>{this.eventBus.emit(e,s)};this.onRoute=(...e)=>{this.onRouteCallbacks.push(...e)};this.onBeforeRoute=(...e)=>{this.onBeforeRouteCallbacks.push(...e)};this.onAfterRoute=(...e)=>{this.onAfterRouteCallbacks.push(...e)};this.load=e,this.loadApps=e,this.loadAssets=e,this.loadComponents=e,this.loadCsses=e,this.loadFunctions=e,this.loadConfigs=e,window.addEventListener("hashchange",async s=>{let t=await this.getAppByRoute(this.activePath);if(t){let[a,p]=this.activePath.split("?"),o={};r(p)||(o=p.split("&").reduce((n,l)=>{let[f,I]=l.split("=");return n[f]=I,n},{}));for(let n of this.onBeforeRouteCallbacks)if(n(t,a,o)===!1){console.log("beforeRoute canceled");return}this.loadedApps.every(n=>n.manifest!==t.manifest)&&this.loadedApps.push(t);for(let n of this.onRouteCallbacks)n(t,a,o);for(let n of this.onAfterRouteCallbacks)n(t,a,o)}else console.log("not found matched app");this.activeApp=t??this.activeApp,console.log("find route",t)})}get activePath(){return r(location.hash)?"/":location.hash.substring(1)}registerApps(...e){for(let s of e)r(s.src)||this.registerdApps.push(s),Array.isArray(s.children)&&this.registerApps(...s.children)}async getAppByRoute(e){if(r(e))return Promise.resolve(null);let s=e;e=`${u(e,"/")}/`;let t=this.registerdApps.filter(o=>{let n=o.route??o.path;return typeof n=="string"?e.startsWith(`${u(n,"/")}/`):n instanceof RegExp?n.test(s):!1}).reduce((o,n)=>o==null||(n.priority??0)>=(o.priority??0)?n:o,null);if(t==null)return Promise.resolve(null);let a;try{a=await this.loadApps(t.src)}catch(o){return console.error("App load error",o),Promise.resolve(null)}let p=(a??[]).filter(o=>r(o.manifest.path)||e.includes(`/${u(o.manifest.path,"/")}/`)).sort((o,n)=>{let l=r(o.manifest.path)?Number.MAX_VALUE:e.indexOf(o.manifest.path),f=r(n.manifest.path)?Number.MAX_VALUE:e.indexOf(n.manifest.path);return l!==f?l-f:(l=r(o.manifest.path)?0:o.manifest.path.split("/").length,f=r(n.manifest.path)?0:n.manifest.path.split("/").length,f-l)});if(p.length>0){let o=p[0];return this.appRouteMap.set(o,t),o}return null}routeTo(e,s){let t=new URLSearchParams;if(s)for(let p in s)s.hasOwnProperty(p)&&t.set(p,s[p]);let a=`#${e}${t.size?`?${t.toString()}`:""}`;a!==location.hash?location.hash=a:window.dispatchEvent(new HashChangeEvent("hashchange"))}getAppRouteInfo(e){return this.appRouteMap.get(e)}};export{h as Host,h as default};
