import{isNullOrEmpty as r,trim as u}from"/commons/string/";function c(i){return{all:i=i||new Map,on:function(e,s){var t=i.get(e);t?t.push(s):i.set(e,[s])},off:function(e,s){var t=i.get(e);t&&(s?t.splice(t.indexOf(s)>>>0,1):i.set(e,[]))},emit:function(e,s){var t=i.get(e);t&&t.slice().map(function(n){n(s)}),(t=i.get("*"))&&t.slice().map(function(n){n(e,s)})}}}var h=class{constructor(e){this.registerdApps=[];this.appRouteMap=new Map;this.loadedApps=[];this.onRouteCallbacks=[];this.onBeforeRouteCallbacks=[];this.onAfterRouteCallbacks=[];this.eventBus=c();this.on=(e,s)=>{this.eventBus.on(e,s)};this.off=e=>{this.eventBus.off(e)};this.emit=(e,s)=>{this.eventBus.emit(e,s)};this.onRoute=(...e)=>{this.onRouteCallbacks.push(...e)};this.onBeforeRoute=(...e)=>{this.onBeforeRouteCallbacks.push(...e)};this.onAfterRoute=(...e)=>{this.onAfterRouteCallbacks.push(...e)};this.load=e,this.loadApps=e,window.addEventListener("hashchange",async s=>{let t=await this.getAppByRoute(this.activePath);if(t){let[n,p]=this.activePath.split("?"),o={};r(p)||(o=p.split("&").reduce((a,l)=>{let[f,I]=l.split("=");return a[f]=I,a},{}));for(let a of this.onBeforeRouteCallbacks)if(a(t,n,o)===!1){history.back();return}this.loadedApps.every(a=>a.manifest!==t.manifest)&&this.loadedApps.push(t);for(let a of this.onRouteCallbacks)a(t,n,o);for(let a of this.onAfterRouteCallbacks)a(t,n,o)}else console.log("not found matched app");this.activeApp=t??this.activeApp,console.log("find route",t)})}get activePath(){return r(location.hash)?"/":location.hash.substring(1)}registerApps(...e){for(let s of e)r(s.src)||this.registerdApps.push(s),Array.isArray(s.children)&&this.registerApps(...s.children)}async getAppByRoute(e){if(r(e))return Promise.resolve(null);let s=e;e=`${u(e,"/")}/`;let t=this.registerdApps.filter(o=>{let a=o.route??o.path;return typeof a=="string"?e.startsWith(`${u(a,"/")}/`):a instanceof RegExp?a.test(s):!1}).reduce((o,a)=>o==null||(a.priority??0)>=(o.priority??0)?a:o,null);if(t==null)return Promise.resolve(null);let n;try{n=await this.loadApps(t.src)}catch(o){return console.error("App load error",o),Promise.resolve(null)}let p=(n??[]).filter(o=>r(o.manifest.path)||e.includes(`/${u(o.manifest.path,"/")}/`)).sort((o,a)=>{let l=r(o.manifest.path)?Number.MAX_VALUE:e.indexOf(o.manifest.path),f=r(a.manifest.path)?Number.MAX_VALUE:e.indexOf(a.manifest.path);return l!==f?l-f:(l=r(o.manifest.path)?0:o.manifest.path.split("/").length,f=r(a.manifest.path)?0:a.manifest.path.split("/").length,f-l)});if(p.length>0){let o=p[0];return this.appRouteMap.set(o,t),o}return null}routeTo(e,s){let t=new URLSearchParams;if(s)for(let p in s)s.hasOwnProperty(p)&&t.set(p,s[p]);let n=`#${e}${t.size?`?${t.toString()}`:""}`;n!==location.hash?location.hash=n:window.dispatchEvent(new HashChangeEvent("hashchange"))}getAppRouteInfo(e){return this.appRouteMap.get(e)}};export{h as Host,h as default};
